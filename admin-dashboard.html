<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZAGA Technologies</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css">

    <style>
        body {
          padding-top: 90px;
          background-color: #f9f9f9;
        }
        .dashboard-container { padding: 30px; }
        .form-control, .btn { border-radius: 10px; }
        .table th, .table td { vertical-align: middle; }
        .dataTables_filter input {
          border-radius: 10px;
          padding: 5px 10px;
        }
    </style>
</head>

<body>
<!-- âœ… Navbar -->
<nav class="navbar navbar-expand-lg navbar-light bg-white py-3 fixed-top">
    <div class="container">
        <a class="navbar-brand d-flex align-items-center" href="index.html">
            <img src="./img/zaga-logo.jpg" alt="ZAGA Technologies Logo" style="height: 40px; width: auto; margin-right: 8px;">
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent">
            <span><i id="bar" class="fas fa-bars"></i></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
                <li class="nav-item"><a class="nav-link" href="shop.html">Our Store</a></li>
                <li class="nav-item"><a class="nav-link" href="about.html">About Us</a></li>
                <li class="nav-item"><a class="nav-link" href="contact.html">Contact Us</a></li>
                <li class="nav-item"><a class="nav-link" href="blog.html">Blogs</a></li>
                <li class="nav-item"><a class="nav-link active" href="admin-dashboard.html">Dashboard</a></li>
                <li class="nav-item"><a class="nav-link" href="cart.html" title="View Cart"><i class="fas fa-shopping-bag"></i></a></li>
                <li class="nav-item"><a class="nav-link" href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
        </div>
    </div>
</nav>

<!-- âœ… Admin Dashboard Section -->
<div class="container dashboard-container">
    <h2 class="mb-4 text-center fw-bold">Admin Dashboard</h2>

    <!-- Add / Edit Product Form -->
    <div class="card p-4 mb-5">
        <h5 id="formTitle">Add New Product</h5>
        <div id="formFeedback" class="alert d-none" role="alert"></div>
        <form id="addProductForm">
            <input type="hidden" id="editProductId">
            <div class="row g-3">
                <div class="col-md-6">
                    <input type="text" id="productName" class="form-control" placeholder="Product Name" required>
                </div>
                <div class="col-md-6">
                    <input type="text" id="productBrand" class="form-control" placeholder="Brand" required>
                </div>
                <div class="col-md-6">
                    <input type="number" id="productPrice" class="form-control" placeholder="Price (UGX)" required>
                </div>
                <div class="col-md-6">
                    <button type="button" class="btn btn-outline-secondary w-100" id="uploadImageButton">
                        <i class="fas fa-cloud-upload-alt"></i> Upload Image
                    </button>
                    <small id="imageNote" class="text-muted d-block mt-1">
                        Current image: <span id="currentImageStatus">None</span>
                    </small>
                    <input type="hidden" id="productImageUrl">
                </div>
                <div class="col-12">
                    <textarea id="productDesc" class="form-control" rows="3" placeholder="Product Description" required></textarea>
                </div>
            </div>
            <button type="submit" class="btn btn-primary mt-3 px-4" id="submitBtn">Add Product</button>
            <button type="button" class="btn btn-secondary mt-3 px-4 d-none" id="cancelEditBtn">Cancel</button>
        </form>
    </div>

    <!-- âœ… Product List Table -->
    <div class="card p-4">
        <h5>Product List</h5>
        <div id="loadingText" class="text-muted small mb-2">Loading products...</div>
        <div class="table-responsive">
            <table id="productTable" class="table table-striped table-bordered mt-3" style="width:100%">
                <thead class="table-light">
                <tr>
                    <th>Image</th>
                    <th>Name</th>
                    <th>Brand</th>
                    <th>Price (UGX)</th>
                    <th>Action</th>
                </tr>
                </thead>
                <tbody id="productTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<footer class="mt-5 py-5">
    <div class="row container mx-auto pb-5">
        <div class="footer-one col-lg-3 col-md-6 col-12">
            <h5>ZAGA-Technologies</h5>
            <p class="pt-3">ZAGA-Technologies is one of Ugandaâ€™s leading independent retailers of laptops, printers
                and Desktops Computers. We stock hundreds of products from the big brands like lenovo, Hp, Dell and
                Microsoft all at the best prices.</p>
        </div>
        <div class="footer-one col-lg-3 col-md-6 col-12 mb-3">
            <h5 class="pb-2">Quik links</h5>
            <ul class="text-uppercase list-unstyled">
                <li><a href="shop.html">Our store</a></li>
                <li><a href="cart.html">Cart</a></li>
                <li><a href="about.html">About Us</a></li>
                <li><a href="blog.html">Blogs</a></li>
                <li><a href="admin-dashboard.html">dashboard</a></li>
                <li><a href="contact.html">Contact Us</a></li>
            </ul>
        </div>
        <div class="footer-one col-lg-3 col-md-6 col-12 mb-3">
            <h5 class="pb-2">Contact Us</h5>
            <div>
                <h6 class="text-uppercase">Address</h6>
                <p>Kabaka kintu House Level- 1 shop No: C-03</p>
                <p>opp king Fahad plaza - Kampala rd.</p>
            </div>
            <div>
                <h6 class="text-uppercase">Phone</h6>
                <p>+256 700706809</p>
            </div>
            <div>
                <h6 class="text-uppercase">Email</h6>
                <p>sales2.zagatechnologiesltd@gmail.com</p>
            </div>
        </div>
        <div class="footer-one col-lg-3 col-md-6 col-12">
            <h5 class="pb-2">Brand Partners</h5>
            <div class="row">
                <img class="img-fluid w-25 h-100 m-2" src="img/brand/apple.png" alt="">
                <img class="img-fluid w-25 h-100 m-2" src="img/brand/samsung.png" alt="">
                <img class="img-fluid w-25 h-100 m-2" src="img/brand/hp%20logo.png" alt="">
                <img class="img-fluid w-25 h-100 m-2" src="img/brand/dell.png" alt="">
                <img class="img-fluid w-25 h-100 m-2" src="img/brand/lenovo.png" alt="">
            </div>
        </div>
    </div>

    <div class="copyright mt-5">
        <div class="row container mx-auto">
            <div class="col-lg-3 col-md-6 col-12 mb-4">
                <img src="img/payment.png" alt="">
            </div>
            <div class="col-lg-4 col-md-6 col-12 text-nowrap mb-2">
                <p>Zaga Technologies Â© 2025. All Rights Reserved </p>
            </div>
            <div class="col-lg-4 col-md-6 col-12">
                <a href=""><i class="fab fa-facebook-f"></i></a>
                <a href=""><i class="fab fa-instagram"></i></a>
                <a href=""><i class="fab fa-tiktok"></i></a>
            </div>
        </div>
    </div>
</footer>

<!-- âœ… Load Cloudinary Upload Widget -->
<script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>

<!-- âœ… Firebase Integration -->
<script type="module">
    import { auth } from "./js/firebase-config.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import {
      subscribeToProducts,
      createProduct,
      updateProduct,
      deleteProduct,
      mapProductDoc,
      formatPrice,
      parsePrice
    } from "./js/services/products-service.js";

    const ADMIN_EMAIL = 'sales2.zagatechnologiesltd@gmail.com';
    const CLOUD_NAME = 'dfjal56p0';
    const UPLOAD_PRESET = 'product_images';

    const addProductForm = document.getElementById('addProductForm');
    const loadingText = document.getElementById('loadingText');
    const formTitle = document.getElementById('formTitle');
    const submitBtn = document.getElementById('submitBtn');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const editProductId = document.getElementById('editProductId');
    const feedbackBanner = document.getElementById('formFeedback');
    const productTableBody = document.getElementById('productTableBody');
    const uploadImageButton = document.getElementById('uploadImageButton');
    const productImageUrl = document.getElementById('productImageUrl');
    const currentImageStatus = document.getElementById('currentImageStatus');

    let unsubscribeProducts = null;
    let currentProducts = [];
    let editingProduct = null;

    const DEFAULT_IMAGE = 'img/shop/default.jpg';

    const escapeHtml = (unsafeText = '') =>
      unsafeText
        .replace(/&/g, '&amp;')
        .replace(/</g, '<')
        .replace(/>/g, '>')
        .replace(/\"/g, '&quot;')
        .replace(/'/g, '&#039;');

    const showFeedback = (message, type = 'success') => {
      if (!message) {
        feedbackBanner.classList.add('d-none');
        feedbackBanner.textContent = '';
        feedbackBanner.classList.remove('alert-success', 'alert-danger', 'alert-info');
        return;
      }
      feedbackBanner.classList.remove('d-none', 'alert-success', 'alert-danger', 'alert-info');
      feedbackBanner.classList.add(`alert-${type}`);
      feedbackBanner.textContent = message;
      setTimeout(() => {
        feedbackBanner.classList.add('d-none');
      }, 4000);
    };

    const resetForm = () => {
      addProductForm.reset();
      productImageUrl.value = '';
      currentImageStatus.textContent = 'None';
      editProductId.value = '';
      editingProduct = null;
      formTitle.textContent = 'Add New Product';
      submitBtn.textContent = 'Add Product';
      cancelEditBtn.classList.add('d-none');
    };

    const openCloudinaryWidget = () => {
        const widget = cloudinary.createUploadWidget({
            cloudName: CLOUD_NAME,
            uploadPreset: UPLOAD_PRESET,
            sources: ['local', 'url'],
            multiple: false,
            folder: 'products'
        }, (error, result) => {
            if (!error && result && result.event === 'success') {
                productImageUrl.value = result.info.secure_url;
                currentImageStatus.textContent = 'Uploaded';
                currentImageStatus.style.color = 'green';
            } else if (result && result.event === 'abort') {
                showFeedback('Upload cancelled.', 'info');
            }
        });
        widget.open();
    };

    const renderProducts = () => {
      if (!currentProducts.length) {
        loadingText.textContent = 'No products found yet.';
        productTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-4">No products available. Add one above.</td></tr>`;
        return;
      }

      loadingText.textContent = '';
      const rows = currentProducts.map(product => {
        const imageSrc = product.imageUrl || DEFAULT_IMAGE;
        const priceLabel = formatPrice(product.price);
        return `
          <tr>
            <td><img src="${escapeHtml(imageSrc)}" width="60" class="rounded border" alt="${escapeHtml(product.name)}"></td>
            <td>${escapeHtml(product.name)}</td>
            <td>${escapeHtml(product.brand)}</td>
            <td>${priceLabel}</td>
            <td>
              <button class="btn btn-warning btn-sm me-2" data-action="edit" data-id="${product.id}">Edit</button>
              <button class="btn btn-danger btn-sm" data-action="delete" data-id="${product.id}">Delete</button>
            </td>
          </tr>
        `;
      }).join('');

      productTableBody.innerHTML = rows;
    };

    onAuthStateChanged(auth, (user) => {
      if (!user || user.email !== ADMIN_EMAIL) {
        alert('Access Denied! Admin login required.');
        window.location.href = 'login.html';
      }
    });

    unsubscribeProducts = subscribeToProducts((snapshot) => {
      currentProducts = snapshot.docs.map(mapProductDoc);
      renderProducts();
    }, (error) => {
      console.error('Error loading products:', error);
      loadingText.textContent = 'Failed to load products. Please refresh and try again.';
    });

    uploadImageButton.addEventListener('click', openCloudinaryWidget);

    addProductForm.addEventListener('submit', async (event) => {
      event.preventDefault();

      const name = document.getElementById('productName').value.trim();
      const brand = document.getElementById('productBrand').value.trim();
      const rawPrice = document.getElementById('productPrice').value.trim();
      const description = document.getElementById('productDesc').value.trim();
      const imageUrl = productImageUrl.value.trim();

      const price = parsePrice(rawPrice);

      if (!name || !brand || !description) {
        showFeedback('Please fill in all product details.', 'danger');
        return;
      }

      if (price <= 0) {
        showFeedback('Please enter a valid price (greater than 0).', 'danger');
        return;
      }

      if (!editingProduct && !imageUrl) {
        showFeedback('Please upload an image for the product.', 'danger');
        return;
      }

      try {
        if (!editingProduct) {
          await createProduct({ name, brand, price, description, imageUrl });
          showFeedback('âœ… Product added successfully!', 'success');
        } else {
          await updateProduct(
            editingProduct.id,
            { name, brand, price, description, imageUrl }
          );
          showFeedback('âœ… Product updated successfully!', 'success');
        }
        resetForm();
      } catch (error) {
        console.error('Error saving product:', error);
        showFeedback(`âŒ Error saving product: ${error.message}`, 'danger');
      }
    });

    cancelEditBtn.addEventListener('click', resetForm);

    productTableBody.addEventListener('click', async (event) => {
      const actionButton = event.target.closest('button[data-action]');
      if (!actionButton) return;

      const productId = actionButton.dataset.id;
      const action = actionButton.dataset.action;
      const product = currentProducts.find((item) => item.id === productId);
      if (!product) return;

      if (action === 'edit') {
        editingProduct = product;
        editProductId.value = product.id;
        document.getElementById('productName').value = product.name;
        document.getElementById('productBrand').value = product.brand;
        document.getElementById('productPrice').value = parsePrice(product.price);
        document.getElementById('productDesc').value = product.description;
        productImageUrl.value = product.imageUrl || '';
        currentImageStatus.textContent = product.imageUrl ? 'Uploaded' : 'None';
        currentImageStatus.style.color = product.imageUrl ? 'green' : 'gray';

        formTitle.textContent = 'Edit Product';
        submitBtn.textContent = 'Update Product';
        cancelEditBtn.classList.remove('d-none');
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      if (action === 'delete') {
        const confirmed = confirm('Are you sure you want to delete this product?');
        if (!confirmed) return;

        try {
          await deleteProduct(product.id);
          showFeedback('ðŸ—‘ï¸ Product deleted.', 'info');
        } catch (error) {
          console.error('Error deleting product:', error);
          showFeedback(`Failed to delete product: ${error.message}`, 'danger');
        }
      }
    });

    document.getElementById('logoutBtn').addEventListener('click', async (event) => {
      event.preventDefault();
      try {
        await signOut(auth);
        localStorage.removeItem('adminLoggedIn');
        localStorage.removeItem('userRole');
        window.location.href = 'login.html';
      } catch (error) {
        console.error('Logout error:', error);
        showFeedback('Error logging out. Please try again.', 'danger');
      }
    });

    window.addEventListener('beforeunload', () => {
      if (unsubscribeProducts) {
        unsubscribeProducts();
      }
    });
</script>

<!-- âœ… Libraries -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>