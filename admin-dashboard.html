<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZAGA Technologies</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css">

    <!-- âœ… DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap4.min.css">

    <style>
        body {
          padding-top: 90px;
          background-color: #f9f9f9;
        }
        .dashboard-container { padding: 30px; }
        .form-control, .btn { border-radius: 10px; }
        .table th, .table td { vertical-align: middle; }
        .dataTables_filter input {
          border-radius: 10px;
          padding: 5px 10px;
        }
    </style>
</head>

<body>
<!-- âœ… Navbar -->
<nav class="navbar navbar-expand-lg navbar-light bg-white py-3 fixed-top">
    <div class="container">
        <a class="navbar-brand d-flex align-items-center" href="index.html">
            <img src="./img/zaga-logo.jpg" alt="ZAGA Technologies Logo" style="height: 40px; width: auto; margin-right: 8px;">
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent">
            <span><i id="bar" class="fas fa-bars"></i></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
                <li class="nav-item"><a class="nav-link" href="shop.html">Our Store</a></li>
                <li class="nav-item"><a class="nav-link" href="about.html">About Us</a></li>
                <li class="nav-item"><a class="nav-link" href="contact.html">Contact Us</a></li>
                <li class="nav-item"><a class="nav-link active" href="admin-dashboard.html">Dashboard</a></li>
                <li class="nav-item"><a class="nav-link" href="cart.html" title="View Cart"><i class="fas fa-shopping-bag"></i></a></li>
                <li class="nav-item"><a class="nav-link" href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
        </div>
    </div>
</nav>

<!-- âœ… Admin Dashboard Section -->
<div class="container dashboard-container">
    <h2 class="mb-4 text-center fw-bold">Admin Dashboard</h2>

    <!-- Add / Edit Product Form -->
    <div class="card p-4 mb-5">
        <h5 id="formTitle">Add New Product</h5>
        <form id="addProductForm">
            <input type="hidden" id="editProductId">
            <div class="row g-3">
                <div class="col-md-6">
                    <input type="text" id="productName" class="form-control" placeholder="Product Name" required>
                </div>
                <div class="col-md-6">
                    <input type="text" id="productBrand" class="form-control" placeholder="Brand" required>
                </div>
                <div class="col-md-6">
                    <input type="number" id="productPrice" class="form-control" placeholder="Price (UGX)" required>
                </div>
                <div class="col-md-6">
                    <input type="file" id="productImage" class="form-control" accept="image/*">
                    <small id="imageNote" class="text-muted">Leave empty to keep current image when editing.</small>
                </div>
                <div class="col-12">
                    <textarea id="productDesc" class="form-control" rows="3" placeholder="Product Description" required></textarea>
                </div>
            </div>
            <button type="submit" class="btn btn-primary mt-3 px-4" id="submitBtn">Add Product</button>
            <button type="button" class="btn btn-secondary mt-3 px-4 d-none" id="cancelEditBtn">Cancel</button>
        </form>
    </div>

    <!-- âœ… Product List Table -->
    <div class="card p-4">
        <h5>Product List</h5>
        <div id="loadingText" class="text-muted small mb-2">Loading products...</div>
        <div class="table-responsive">
            <table id="productTable" class="table table-striped table-bordered mt-3" style="width:100%">
                <thead class="table-light">
                <tr>
                    <th>Image</th>
                    <th>Name</th>
                    <th>Brand</th>
                    <th>Price (UGX)</th>
                    <th>Action</th>
                </tr>
                </thead>
                <tbody id="productTableBody"></tbody>
            </table>
        </div>
    </div>
</div>


<footer class="mt-5 py-5">
    <div class="row container mx-auto pb-5">
        <div class="footer-one col-lg-3 col-md-6 col-12">
            <h5>ZAGA-Technologies</h5>
            <p class="pt-3">ZAGA-Technologies is one of Ugandaâ€™s leading independent retailers of laptops, printers
                and Desktops Computers. We stock hundreds of products from the big brands like lenovo, Hp, Dell and
                Microsoft all at the best prices.</p>
        </div>
        <div class="footer-one col-lg-3 col-md-6 col-12 mb-3">
            <h5 class="pb-2">Quik links</h5>
            <ul class="text-uppercase list-unstyled">
                <li><a href="shop.html">Our store</a></li>
                <li><a href="cart.html">Cart</a></li>
                <li><a href="about.html">About Us</a></li>
                <li><a href="admin-dashboard.html">dashboard</a></li>
                <li><a href="contact.html">Contact Us</a></li>

            </ul>
        </div>
        <div class="footer-one col-lg-3 col-md-6 col-12 mb-3">
            <h5 class="pb-2">Contact Us</h5>
            <div>
                <h6 class="text-uppercase">Address</h6>
                <p>Kabaka kintu House Level- 1 shop No: C-03</p>
                <p>opp king Fahad plaza - Kampala rd.</p>
            </div>
            <div>
                <h6 class="text-uppercase">Phone</h6>
                <p>+256 700706809</p>
            </div>
            <div>
                <h6 class="text-uppercase">Email</h6>
                <p>sales2.zagatechnologiesltd@gmail.com</p>
            </div>
        </div>
        <div class="footer-one col-lg-3 col-md-6 col-12">
            <h5 class="pb-2">Brand Partners</h5>
            <div class="row">
                <img class="img-fluid w-25 h-100 m-2"src="img/brand/apple.png" alt="">
                <img class="img-fluid w-25 h-100 m-2"src="img/brand/samsung.png" alt="">
                <img class="img-fluid w-25 h-100 m-2"src="img/brand/hp%20logo.png" alt="">
                <img class="img-fluid w-25 h-100 m-2"src="img/brand/dell.png" alt="">
                <img class="img-fluid w-25 h-100 m-2"src="img/brand/lenovo.png" alt="">
            </div>
        </div>
    </div>

    <div class="copyright mt-5">
        <div class="row container mx-auto">
            <div class="col-lg-3 col-md-6 col-12 mb-4">
                <img src="img/payment.png" alt="">
            </div>
            <div class="col-lg-4 col-md-6 col-12 text-nowrap mb-2">
                <p>Zaga Technologies Â© 2025. All Rights Reserved </p>
            </div>
            <div class="col-lg-4 col-md-6 col-12">
                <a href=""><i class="fab fa-facebook-f"></i></a>
                <a href=""><i class="fab fa-instagram"></i></a>
                <a href=""><i class="fab fa-tiktok"></i></a>
            </div>
        </div>
    </div>
</footer>

<!-- âœ… Firebase Integration -->
<script type="module">
    import { auth, db, storage } from "./js/firebase-config.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { collection, addDoc, getDocs, deleteDoc, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { ref, uploadBytes, getDownloadURL, deleteObject, refFromURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

    const ADMIN_EMAIL = 'sales2.zagatechnologiesltd@gmail.com';

    // Proper admin authentication check
    onAuthStateChanged(auth, (user) => {
      if (!user || user.email !== ADMIN_EMAIL) {
        alert('Access Denied! Admin login required.');
        window.location.href = 'login.html';
      }
    });

    const addProductForm = document.getElementById('addProductForm');
    const productTableBody = document.getElementById('productTableBody');
    const loadingText = document.getElementById('loadingText');
    const formTitle = document.getElementById('formTitle');
    const submitBtn = document.getElementById('submitBtn');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const editProductId = document.getElementById('editProductId');
    let dataTable;

    // âœ… Load Products (READ)
    async function loadProducts() {
      productTableBody.innerHTML = '';
      loadingText.textContent = 'Loading...';
      const querySnapshot = await getDocs(collection(db, "products"));
      loadingText.textContent = '';

      querySnapshot.forEach((docSnap) => {
        const data = docSnap.data();
        const row = `
          <tr>
            <td><img src="${data.imageUrl}" width="60" class="rounded"></td>
            <td>${data.name}</td>
            <td>${data.brand}</td>
            <td>${data.price}</td>
            <td>
              <button class="btn btn-warning btn-sm me-2" onclick="editProduct('${docSnap.id}')">Edit</button>
              <button class="btn btn-danger btn-sm" onclick="deleteProduct('${docSnap.id}', '${data.imageUrl}')">Delete</button>
            </td>
          </tr>`;
        productTableBody.innerHTML += row;
      });

      // Initialize DataTable after loading
      if (dataTable) dataTable.destroy();
      dataTable = $('#productTable').DataTable();
    }

    loadProducts();

    // âœ… Add or Update Product
    addProductForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = editProductId.value;
      const name = document.getElementById('productName').value.trim();
      const brand = document.getElementById('productBrand').value.trim();
      const price = document.getElementById('productPrice').value.trim();
      const description = document.getElementById('productDesc').value.trim();
      const imageFile = document.getElementById('productImage').files[0];

      try {
        if (!id) {
          if (!imageFile) return alert('Please upload an image.');
          const imageRef = ref(storage, 'products/' + imageFile.name);
          await uploadBytes(imageRef, imageFile);
          const imageUrl = await getDownloadURL(imageRef);
          await addDoc(collection(db, "products"), { name, brand, price, description, imageUrl, createdAt: new Date() });
          alert('âœ… Product added successfully!');
        } else {
          const docRef = doc(db, "products", id);
          const existingDoc = await getDoc(docRef);
          let imageUrl = existingDoc.data().imageUrl;

          if (imageFile) {
            const newImageRef = ref(storage, 'products/' + imageFile.name);
            await uploadBytes(newImageRef, imageFile);
            imageUrl = await getDownloadURL(newImageRef);
          }

          await updateDoc(docRef, { name, brand, price, description, imageUrl });
          alert('âœ… Product updated successfully!');
          formTitle.textContent = "Add New Product";
          submitBtn.textContent = "Add Product";
          cancelEditBtn.classList.add('d-none');
        }

        addProductForm.reset();
        editProductId.value = "";
        loadProducts();
      } catch (error) {
        console.error(error);
        alert('âŒ Error saving product: ' + error.message);
      }
    });

    // âœ… Edit Product
    window.editProduct = async (id) => {
      const docRef = doc(db, "products", id);
      const docSnap = await getDoc(docRef);
      if (docSnap.exists()) {
        const data = docSnap.data();
        document.getElementById('productName').value = data.name;
        document.getElementById('productBrand').value = data.brand;
        document.getElementById('productPrice').value = data.price;
        document.getElementById('productDesc').value = data.description;
        editProductId.value = id;

        formTitle.textContent = "Edit Product";
        submitBtn.textContent = "Update Product";
        cancelEditBtn.classList.remove('d-none');
      }
    };

    // âœ… Cancel Edit
    cancelEditBtn.addEventListener('click', () => {
      addProductForm.reset();
      editProductId.value = "";
      formTitle.textContent = "Add New Product";
      submitBtn.textContent = "Add Product";
      cancelEditBtn.classList.add('d-none');
    });

    // âœ… Delete Product
    window.deleteProduct = async (id, imageUrl) => {
      if (!confirm('Are you sure you want to delete this product?')) return;
      await deleteDoc(doc(db, "products", id));
      try {
        const imageRef = refFromURL(imageUrl);
        await deleteObject(imageRef);
      } catch (err) {
        console.warn('Image deletion skipped:', err.message);
      }
      alert('ðŸ—‘ï¸ Product deleted');
      loadProducts();
    };

    // âœ… Logout functionality
    import { signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    document.getElementById('logoutBtn').addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        await signOut(auth);
        localStorage.removeItem('adminLoggedIn');
        localStorage.removeItem('userRole');
        window.location.href = 'login.html';
      } catch (error) {
        console.error('Logout error:', error);
        alert('Error logging out. Please try again.');
      }
    });
</script>

<!-- âœ… Libraries -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap4.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js" integrity="sha384-7+zCNj/IqJ95wo16oMtfsKbZ9ccEh31eOz1HGyDuCQ6wgnyJNSYdrPa03rtR1zdB" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js" integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13" crossorigin="anonymous"></script>
<script src="sprod.js"></script>
<script type="module" src="./js/firebase-config.js"></script>
</body>
</html>
