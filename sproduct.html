<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZAGA Technologies | Product Details</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
          integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/v4-shims.css">

    <!-- Page-specific styling -->
    <style>
        body {
          font-family: 'Poppins', sans-serif;
          background-color: #f5f7fa;
          margin: 0;
          padding: 0;
        }

        .product-container {
          max-width: 1200px;
          margin: 120px auto 60px;
          background: #fff;
          border-radius: 12px;
          padding: 40px;
          box-shadow: 0 4px 15px rgba(0,0,0,0.1);
          display: flex;
          gap: 40px;
          align-items: flex-start;
        }

        .product-image {
          flex: 1;
          text-align: center;
        }

        .product-image img {
          width: 100%;
          max-width: 400px;
          border-radius: 10px;
          transition: transform 0.3s ease;
        }

        .product-image img:hover {
          transform: scale(1.03);
        }

        .product-info {
          flex: 2;
          color: #333;
        }

        .product-info h2 {
          font-size: 2rem;
          color: #1a1a1a;
          margin-bottom: 15px;
        }

        .product-info h3 {
          color: #007bff;
          font-size: 1.6rem;
          margin-bottom: 20px;
        }

        .product-info p {
          font-size: 1.1rem;
          line-height: 1.6;
          color: #555;
          margin-bottom: 25px;
        }

        .product-actions {
          display: flex;
          gap: 15px;
        }

        .btn {
          padding: 10px 25px;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          font-size: 1rem;
          transition: 0.3s ease;
        }

        .btn-primary {
          background-color: #007bff;
          color: white;
        }

        .btn-primary:hover {
          background-color: #0056b3;
        }

        .btn-secondary {
          background-color: #6c757d;
          color: white;
        }

        .btn-secondary:hover {
          background-color: #5a6268;
        }

        .small-images {
          display: flex;
          gap: 10px;
          margin-top: 20px;
          justify-content: center;
        }

        .small-images img {
          width: 80px;
          height: 80px;
          object-fit: cover;
          border-radius: 6px;
          cursor: pointer;
          transition: transform 0.3s;
        }

        .small-images img:hover {
          transform: scale(1.05);
        }

        .back-link {
          text-align: center;
          margin: 40px 0;
        }

        .back-link a {
          color: #007bff;
          text-decoration: none;
          font-weight: 600;
          transition: 0.3s;
        }

        .back-link a:hover {
          text-decoration: underline;
        }

        @media (max-width: 768px) {
          .product-container {
            flex-direction: column;
            padding: 20px;
          }

          .product-image img {
            max-width: 100%;
          }
        }
    </style>
</head>

<body>

<!-- Navbar (unchanged) -->
<nav class="navbar navbar-expand-lg navbar-light bg-white py-3 fixed-top">
    <div class="container">
        <a class="navbar-brand d-flex align-items-center" href="index.html">
            <img src="./img/zaga-logo.jpg" alt="ZAGA Technologies Logo" style="height: 40px; width: auto; margin-right: 8px;">
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                aria-expanded="false" aria-label="Toggle navigation">
            <span><i id="bar" class="fas fa-bars"></i></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item"><a class="nav-link active" href="index.html">Home</a></li>
                <li class="nav-item"><a class="nav-link" href="shop.html">Our Store</a></li>
                <li class="nav-item"><a class="nav-link" href="about.html">About Us</a></li>
                <li class="nav-item"><a class="nav-link" href="contact.html">Contact Us</a></li>
                <li class="nav-item"><a class="nav-link" href="blog.html">Blogs</a></li>
                <li class="nav-item"><a class="nav-link" href="admin-dashboard.html">Dashboard</a></li>
                <li class="nav-item"><a class="nav-link" href="cart.html" title="View Cart"><i class="fas fa-shopping-bag"></i></a></li>
                <li class="nav-item"><a class="nav-link" href="#" id="authBtn">Sign-In/Up</a></li>
            </ul>
        </div>
    </div>
</nav>

<!--Product Section -->
<section class="product-container">
    <div class="product-image">
        <img id="mainImage" src="img/shop/default.jpg" alt="Product Image">
        <div class="small-images" id="smallImages"></div>
    </div>

    <div class="product-info">
        <h2 id="productName">Loading...</h2>
        <h3 id="productPrice">Loading...</h3>
        <p id="productBrand" style="color: #666; font-size: 1rem; margin-bottom: 10px;"></p>
        <p id="productDescription">Loading product details...</p>
        <div class="product-actions">
            <button class="btn btn-primary" id="addToCartBtn"><i class="fas fa-shopping-cart"></i> Add to Cart</button>
            <button class="btn btn-secondary" id="backToShopBtn"><i class="fas fa-arrow-left"></i> Back to Shop</button>
        </div>
        <div id="cartMessage" style="margin-top: 15px; display: none; color: green; font-weight: bold;"></div>
    </div>
</section>


<!--  Footer (unchanged) -->
<footer class="mt-5 py-5">
    <div class="row container mx-auto pb-5">
        <div class="footer-one col-lg-3 col-md-6 col-12">
            <h5>ZAGA-Technologies</h5>
            <p class="pt-3">ZAGA-Technologies is one of Uganda’s leading independent retailers of laptops, printers and Desktops Computers. We stock hundreds of products from the big brands like Lenovo, HP, Dell, and Microsoft all at the best prices.</p>
        </div>
        <div class="footer-one col-lg-3 col-md-6 col-12 mb-3">
            <h5 class="pb-2">Quick Links</h5>
            <ul class="text-uppercase list-unstyled">
                <li><a href="shop.html">Our store</a></li>
                <li><a href="cart.html">Cart</a></li>
                <li><a href="about.html">About Us</a></li>
                <li><a href="blog.html">Blogs</a></li>
                <li><a href="admin-dashboard.html">Dashboard</a></li>
                <li><a href="contact.html">Contact Us</a></li>
            </ul>
        </div>
        <div class="footer-one col-lg-3 col-md-6 col-12 mb-3">
            <h5 class="pb-2">Contact Us</h5>
            <div>
                <h6 class="text-uppercase">Address</h6>
                <p>Kabaka Kintu House Level-1, Shop No: C-03</p>
                <p>Opp King Fahad Plaza - Kampala Rd.</p>
            </div>
            <div>
                <h6 class="text-uppercase">Phone</h6>
                <p>+256 700706809</p>
            </div>
            <div>
                <h6 class="text-uppercase">Email</h6>
                <p>sales2.zagatechnologiesltd@gmail.com</p>
            </div>
        </div>
        <div class="footer-one col-lg-3 col-md-6 col-12">
            <h5 class="pb-2">Brand Partners</h5>
            <div class="row">
                <img class="img-fluid w-25 h-100 m-2" src="img/brand/apple.png" alt="">
                <img class="img-fluid w-25 h-100 m-2" src="img/brand/samsung.png" alt="">
                <img class="img-fluid w-25 h-100 m-2" src="img/brand/hp%20logo.png" alt="">
                <img class="img-fluid w-25 h-100 m-2" src="img/brand/dell.png" alt="">
                <img class="img-fluid w-25 h-100 m-2" src="img/brand/lenovo.png" alt="">
            </div>
        </div>
    </div>

    <div class="copyright mt-5">
        <div class="row container mx-auto">
            <div class="col-lg-3 col-md-6 col-12 mb-4">
                <img src="img/payment.png" alt="">
            </div>
            <div class="col-lg-4 col-md-6 col-12 text-nowrap mb-2">
                <p>Zaga Technologies © 2025. All Rights Reserved</p>
            </div>
            <div class="col-lg-4 col-md-6 col-12">
                <a href="#"><i class="fab fa-facebook-f"></i></a>
                <a href="#"><i class="fab fa-instagram"></i></a>
                <a href="#"><i class="fab fa-tiktok"></i></a>
            </div>
        </div>
    </div>
</footer>

<!-- Firebase Script -->
<script type="module">
    import { auth, db } from './js/firebase-config.js';
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { collection, addDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import {
      subscribeToProduct,
      formatPrice,
      parsePrice
    } from "./js/services/products-service.js";

    const params = new URLSearchParams(window.location.search);
    const productId = params.get('id') || localStorage.getItem("selectedProductId");
    const authBtn = document.getElementById('authBtn');
    const addToCartBtn = document.getElementById('addToCartBtn');
    const backToShopBtn = document.getElementById('backToShopBtn');
    const cartMessage = document.getElementById('cartMessage');
    
    let currentUser = null;
    let currentProduct = null;
    let unsubscribeProduct = null;
    const DEFAULT_IMAGE = 'img/shop/default.jpg';

    // Handle authentication state
    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      if (user) {
        authBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i> Logout';
        authBtn.onclick = logout;
      } else {
        authBtn.innerHTML = 'Sign-In/Up';
        authBtn.href = 'login.html';
        authBtn.onclick = null;
      }
    });

    // Logout function
    async function logout(e) {
      e.preventDefault();
      try {
        await signOut(auth);
        localStorage.removeItem('userLoggedIn');
        localStorage.removeItem('adminLoggedIn');
        localStorage.removeItem('userRole');
        alert('Logged out successfully');
        window.location.href = 'shop.html';
      } catch (error) {
        console.error('Logout error:', error);
        alert('Error logging out');
      }
    }

    if (!productId) {
      document.getElementById('productName').textContent = "No product selected";
    } else {
      unsubscribeProduct = subscribeToProduct(productId, (docSnap) => {
        if (docSnap.exists()) {
          const data = docSnap.data();
          currentProduct = {
            id: docSnap.id,
            ...data
          };

          document.getElementById('productName').textContent = data.name ?? 'Product';
          document.getElementById('productBrand').textContent = `Brand: ${data.brand || 'N/A'}`;
          document.getElementById('productPrice').textContent = formatPrice(data.price);
          document.getElementById('productDescription').textContent = data.description || 'No description available';

          const imageUrl = data.imageUrl || data.imageURL || data.image || DEFAULT_IMAGE;
          document.getElementById('mainImage').src = imageUrl;

          const smallImagesContainer = document.getElementById('smallImages');
          smallImagesContainer.innerHTML = '';
          if (Array.isArray(data.smallImages) && data.smallImages.length) {
            data.smallImages.forEach(src => {
              const imgEl = document.createElement('img');
              imgEl.src = src;
              imgEl.alt = data.name || 'product';
              imgEl.onclick = () => document.getElementById('mainImage').src = src;
              smallImagesContainer.appendChild(imgEl);
            });
          }
        } else {
          document.getElementById('productName').textContent = "Product Not Found";
          currentProduct = null;
        }
      }, (error) => {
        console.error("Error loading product:", error);
        document.getElementById('productName').textContent = "Error loading product details.";
        currentProduct = null;
      });
    }

    // Add to Cart function
    addToCartBtn.addEventListener('click', async () => {
      if (!currentUser) {
        alert('Please login to add items to cart');
        window.location.href = 'login.html';
        return;
      }

      if (!currentProduct) {
        alert('Product information not loaded');
        return;
      }

      try {
        const priceNumber = parsePrice(currentProduct.price);
        const imageUrl = currentProduct.imageUrl || currentProduct.imageURL || currentProduct.image || DEFAULT_IMAGE;

        // Add to user's cart
        await addDoc(collection(db, `users/${currentUser.uid}/cart`), {
          productId: currentProduct.id,
          name: currentProduct.name,
          brand: currentProduct.brand || '',
          price: priceNumber,
          image: imageUrl,
          quantity: 1,
          addedAt: new Date()
        });

        cartMessage.textContent = '✅ Added to cart successfully!';
        cartMessage.style.display = 'block';
        cartMessage.style.color = 'green';
        
        setTimeout(() => {
          cartMessage.style.display = 'none';
        }, 3000);

      } catch (error) {
        console.error('Error adding to cart:', error);
        cartMessage.textContent = '❌ Error adding to cart';
        cartMessage.style.display = 'block';
        cartMessage.style.color = 'red';
      }
    });

    // Back to shop button
    backToShopBtn.addEventListener('click', () => {
      window.location.href = 'shop.html';
    });

    window.addEventListener('beforeunload', () => {
      if (unsubscribeProduct) {
        unsubscribeProduct();
      }
    });
</script>


<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"></script>
<script type="module" src="./js/firebase-config.js"></script>
</body>
</html>
