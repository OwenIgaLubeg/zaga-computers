<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZAGA Technologies | Blogs</title>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css">

    <style>
        body {
          padding-top: 90px;
          background-color: #f9f9f9;
        }
        .blog-container {
          padding: 30px 0;
        }
        .blog-card {
          border-radius: 15px;
          overflow: hidden;
          transition: transform 0.3s ease, box-shadow 0.3s ease;
          background: #fff;
        }
        .blog-card:hover {
          transform: translateY(-4px);
          box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .blog-cover {
          width: 100%;
          height: 220px;
          object-fit: cover;
        }
        .blog-meta {
          font-size: 0.85rem;
          color: #6c757d;
        }
        .blog-content {
          white-space: pre-line;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-white py-3 fixed-top">
    <div class="container">
        <a class="navbar-brand d-flex align-items-center" href="index.html">
            <img src="./img/zaga-logo.jpg" alt="ZAGA Technologies Logo" style="height: 40px; width: auto; margin-right: 8px;">
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
                aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span><i id="bar" class="fas fa-bars"></i></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
                <li class="nav-item"><a class="nav-link" href="shop.html">Our Store</a></li>
                <li class="nav-item"><a class="nav-link" href="about.html">About Us</a></li>
                <li class="nav-item"><a class="nav-link" href="contact.html">Contact Us</a></li>
                <li class="nav-item"><a class="nav-link" href="admin-dashboard.html">Dashboard</a></li>
                <li class="nav-item"><a class="nav-link" href="cart.html" title="View Cart"><i class="fas fa-shopping-bag"></i></a></li>
                <li class="nav-item"><a class="nav-link active" href="blog.html">Blogs</a></li>
                <li class="nav-item"><a class="nav-link" href="#" id="authBtn">Sign-In/Up</a></li>
            </ul>
        </div>
    </div>
</nav>

<section class="container blog-container">
    <div class="text-center mb-5">
        <h2 class="fw-bold">ZAGA Insights & Stories</h2>
        <p class="text-muted">Discover tech tips, product highlights, and customer stories shared by the ZAGA community.</p>
    </div>

    <div id="loginReminder" class="alert alert-info d-none" role="alert"></div>

    <div id="blogFormCard" class="card p-4 mb-5 d-none">
        <h5 class="mb-3">Share a Blog Post</h5>
        <div id="blogFormFeedback" class="alert d-none" role="alert"></div>
        <form id="blogForm">
            <div class="form-group">
                <label for="blogTitle">Title</label>
                <input type="text" class="form-control" id="blogTitle" placeholder="Enter blog title" required>
            </div>
            <div class="form-group">
                <label for="blogSummary">Summary</label>
                <input type="text" class="form-control" id="blogSummary" placeholder="A short summary" required>
            </div>
            <div class="form-group">
                <label for="blogContent">Content</label>
                <textarea class="form-control" id="blogContent" rows="5" placeholder="Write your blog content here" required></textarea>
            </div>
            <div class="form-group">
                <label for="blogCover">Cover Image (optional)</label>
                <button type="button" class="btn btn-outline-secondary w-100" id="uploadCoverButton">
                    <i class="fas fa-cloud-upload-alt"></i> Upload Cover Image
                </button>
                <small id="coverImageStatus" class="text-muted d-block mt-1">Current: <span id="coverStatusText">None</span></small>
                <input type="hidden" id="coverImageUrl">
            </div>
            <button type="submit" class="btn btn-primary mt-2">Publish Blog</button>
        </form>
    </div>

    <div id="blogList" class="row g-4"></div>
</section>

<footer class="mt-5 py-5">
    <div class="row container mx-auto pb-5">
        <div class="footer-one col-lg-3 col-md-6 col-12">
            <h5>ZAGA-Technologies</h5>
            <p class="pt-3">ZAGA-Technologies is one of Ugandaâ€™s leading independent retailers of laptops, printers
                and Desktops Computers. We stock hundreds of products from the big brands like lenovo, Hp, Dell and
                Microsoft all at the best prices.</p>
        </div>
        <div class="footer-one col-lg-3 col-md-6 col-12 mb-3">
            <h5 class="pb-2">Quik links</h5>
            <ul class="text-uppercase list-unstyled">
                <li><a href="shop.html">Our store</a></li>
                <li><a href="cart.html">Cart</a></li>
                <li><a href="about.html">About Us</a></li>
                <li><a href="blog.html">Blogs</a></li>
                <li><a href="admin-dashboard.html">dashboard</a></li>
                <li><a href="contact.html">Contact Us</a></li>
            </ul>
        </div>
        <div class="footer-one col-lg-3 col-md-6 col-12 mb-3">
            <h5 class="pb-2">Contact Us</h5>
            <div>
                <h6 class="text-uppercase">Address</h6>
                <p>Kabaka kintu House Level- 1 shop No: C-03</p>
                <p>opp king Fahad plaza - Kampala rd.</p>
            </div>
            <div>
                <h6 class="text-uppercase">Phone</h6>
                <p>+256 700706809</p>
            </div>
            <div>
                <h6 class="text-uppercase">Email</h6>
                <p>sales2.zagatechnologiesltd@gmail.com</p>
            </div>
        </div>
        <div class="footer-one col-lg-3 col-md-6 col-12">
            <h5 class="pb-2">Brand Partners</h5>
            <div class="row">
                <img class="img-fluid w-25 h-100 m-2" src="img/brand/apple.png" alt="">
                <img class="img-fluid w-25 h-100 m-2" src="img/brand/samsung.png" alt="">
                <img class="img-fluid w-25 h-100 m-2" src="img/brand/hp%20logo.png" alt="">
                <img class="img-fluid w-25 h-100 m-2" src="img/brand/dell.png" alt="">
                <img class="img-fluid w-25 h-100 m-2" src="img/brand/lenovo.png" alt="">
            </div>
        </div>
    </div>

    <div class="copyright mt-5">
        <div class="row container mx-auto">
            <div class="col-lg-3 col-md-6 col-12 mb-4">
                <img src="img/payment.png" alt="">
            </div>
            <div class="col-lg-4 col-md-6 col-12 text-nowrap mb-2">
                <p>Zaga Technologies Â© 2025. All Rights Reserved </p>
            </div>
            <div class="col-lg-4 col-md-6 col-12">
                <a href=""><i class="fab fa-facebook-f"></i></a>
                <a href=""><i class="fab fa-instagram"></i></a>
                <a href=""><i class="fab fa-tiktok"></i></a>
            </div>
        </div>
    </div>
</footer>

<!-- Cloudinary Upload Widget -->
<script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>

<script type="module">
    import { auth } from "./js/firebase-config.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { createBlog, subscribeToBlogs, deleteBlog, mapBlogDoc } from "./js/services/blogs-service.js";

    const ADMIN_EMAIL = 'sales2.zagatechnologiesltd@gmail.com';
    const CLOUD_NAME = 'dfjal56p0'; // Your Cloudinary Cloud Name
    const UPLOAD_PRESET = 'product_images'; // Reuse your existing preset (or create a new one)

    const blogList = document.getElementById('blogList');
    const blogFormCard = document.getElementById('blogFormCard');
    const blogForm = document.getElementById('blogForm');
    const blogFormFeedback = document.getElementById('blogFormFeedback');
    const loginReminder = document.getElementById('loginReminder');
    const authBtn = document.getElementById('authBtn');
    const uploadCoverButton = document.getElementById('uploadCoverButton');
    const coverImageUrl = document.getElementById('coverImageUrl');
    const coverStatusText = document.getElementById('coverStatusText');

    let currentUser = null;
    let isAdmin = false;
    let unsubscribeBlogs = null;

    const DEFAULT_COVER = 'img/banner/2.jpg';

    const showFormFeedback = (message, type = 'success') => {
      if (!message) {
        blogFormFeedback.classList.add('d-none');
        blogFormFeedback.textContent = '';
        return;
      }
      blogFormFeedback.classList.remove('d-none', 'alert-success', 'alert-danger', 'alert-info');
      blogFormFeedback.classList.add(`alert-${type}`);
      blogFormFeedback.textContent = message;
      setTimeout(() => blogFormFeedback.classList.add('d-none'), 3500);
    };

    const openCoverUpload = () => {
        const widget = cloudinary.createUploadWidget({
            cloudName: CLOUD_NAME,
            uploadPreset: UPLOAD_PRESET,
            sources: ['local', 'url'],
            multiple: false,
            folder: 'blogs'
        }, (error, result) => {
            if (!error && result && result.event === 'success') {
                coverImageUrl.value = result.info.secure_url;
                coverStatusText.textContent = 'Uploaded';
                coverStatusText.style.color = 'green';
            }
        });
        widget.open();
    };

    const renderBlogs = (blogs) => {
      if (!blogs.length) {
        blogList.innerHTML = '<div class="col-12 text-center text-muted">No blog posts yet. Be the first to share!</div>';
        return;
      }

      blogList.innerHTML = blogs.map(blog => {
        const cover = blog.coverImageUrl || DEFAULT_COVER;
        const createdAt = blog.createdAt?.toDate ? blog.createdAt.toDate() : new Date();
        const formattedDate = createdAt.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });
        const canManage = isAdmin || (currentUser && blog.authorId === currentUser.uid);

        return `
          <div class="col-lg-4 col-md-6 col-12 mb-4">
            <div class="blog-card h-100 shadow-sm">
              <img src="${cover}" class="blog-cover" alt="${blog.title}">
              <div class="p-4 d-flex flex-column h-100">
                <h5>${blog.title}</h5>
                <p class="blog-meta mb-2">By ${blog.authorName || 'Anonymous'} â€¢ ${formattedDate}</p>
                <p class="text-muted">${blog.summary}</p>
                <p class="blog-content flex-grow-1">${blog.content}</p>
                ${canManage ? `<button class="btn btn-outline-danger btn-sm mt-3 align-self-start" data-action="delete" data-id="${blog.id}"><i class="fas fa-trash"></i> Delete</button>` : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    };

    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      isAdmin = !!(user && user.email === ADMIN_EMAIL);

      if (user) {
        blogFormCard.classList.remove('d-none');
        loginReminder.classList.add('d-none');
        authBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i> Logout';
        authBtn.onclick = async (e) => {
          e.preventDefault();
          try {
            await signOut(auth);
            window.location.reload();
          } catch (error) {
            console.error('Logout error:', error);
            alert('Error logging out. Please try again.');
          }
        };
      } else {
        blogFormCard.classList.add('d-none');
        loginReminder.classList.remove('d-none');
        loginReminder.textContent = 'Please sign in to share your blog post.';
        authBtn.innerText = 'Sign-In/Up';
        authBtn.href = 'login.html';
        authBtn.onclick = null;
      }
    });

    uploadCoverButton.addEventListener('click', openCoverUpload);

    blogForm.addEventListener('submit', async (event) => {
      event.preventDefault();

      if (!currentUser) {
        showFormFeedback('You need to login to publish a blog.', 'danger');
        return;
      }

      // ðŸ”’ ONLY ADMIN CAN PUBLISH
      if (!isAdmin) {
        showFormFeedback('Only administrators can publish blogs.', 'danger');
        return;
      }

      const title = document.getElementById('blogTitle').value.trim();
      const summary = document.getElementById('blogSummary').value.trim();
      const content = document.getElementById('blogContent').value.trim();
      const coverUrl = coverImageUrl.value.trim();

      if (!title || !summary || !content) {
        showFormFeedback('Please complete all the fields.', 'danger');
        return;
      }

      try {
        await createBlog({
          title,
          summary,
          content,
          authorId: currentUser.uid,
          authorName: currentUser.displayName || currentUser.email || 'Anonymous',
          coverImageUrl: coverUrl || null
        });

        blogForm.reset();
        coverImageUrl.value = '';
        coverStatusText.textContent = 'None';
        coverStatusText.style.color = 'gray';
        showFormFeedback('âœ… Blog published successfully!', 'success');
      } catch (error) {
        console.error('Error creating blog:', error);
        showFormFeedback(`âŒ Failed to publish blog: ${error.message}`, 'danger');
      }
    });

    blogList.addEventListener('click', async (event) => {
      const deleteButton = event.target.closest('[data-action="delete"]');
      if (!deleteButton) return;

      const blogId = deleteButton.dataset.id;
      if (!blogId) return;

      const confirmDelete = confirm('Are you sure you want to delete this blog post?');
      if (!confirmDelete) return;

      try {
        await deleteBlog(blogId);
        showFormFeedback('ðŸ—‘ï¸ Blog deleted.', 'info');
      } catch (error) {
        console.error('Error deleting blog:', error);
        alert('Failed to delete blog.');
      }
    });

    unsubscribeBlogs = subscribeToBlogs((snapshot) => {
      const blogs = snapshot.docs.map(mapBlogDoc);
      renderBlogs(blogs);
    }, (error) => {
      console.error('Error loading blogs:', error);
      blogList.innerHTML = '<div class="col-12 text-center text-danger">Failed to load blogs. Please refresh.</div>';
    });

    window.addEventListener('beforeunload', () => {
      if (unsubscribeBlogs) {
        unsubscribeBlogs();
      }
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js" integrity="sha384-7+zCNj/IqJ95wo16oMtfsKbZ9ccEh31eOz1HGyDuCQ6wgnyJNSYdrPa03rtR1zdB" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js" integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13" crossorigin="anonymous"></script>
</body>
</html>